

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>11. Week 10 - Uniswap &mdash; Plutus Pioneer Program Lecture Notes  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="10. Week 09 - Marlowe" href="week9.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Plutus Pioneer Program Lecture Notes
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="week1.html">2. Week 01 - Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="week2.html">3. Week 02 - Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="week3.html">4. Week 03 - Script Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="week4.html">5. Week 04 - Monads</a></li>
<li class="toctree-l1"><a class="reference internal" href="week5.html">6. Week 05 - Native Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="week6.html">7. Week 06 - Oracles</a></li>
<li class="toctree-l1"><a class="reference internal" href="week7.html">8. Week 07 - State Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="week8.html">9. Week 08 - Property Based Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="week9.html">10. Week 09 - Marlowe</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Week 10 - Uniswap</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-uniswap">11.1. What is Uniswap</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Plutus Pioneer Program Lecture Notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">11. </span>Week 10 - Uniswap</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/week10.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="week-10-uniswap">
<h1><span class="section-number">11. </span>Week 10 - Uniswap<a class="headerlink" href="#week-10-uniswap" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These is a written version of <a class="reference external" href="https://youtu.be/Dg36h9YPMz4">Lecture
#10</a>.</p>
<p>In this lecture we look at an implementation of Uniswap in Plutus.</p>
<p>This is the last lecture in the Plutus Pioneer Program. However, there will be a special lecture once it is possible to deploy contracts to the testnet.</p>
</div>
<p>In this lecture we won’t be introducing any new topics or concepts. Instead we will do an end-to-end walk through of a demo that Lars wrote some months ago that
clones the very popular Uniswap contract from Ethereum.</p>
<p>The one new thing we will look at following several requests is how you can query the endpoints created by the PAB with Curl commands just from the console.</p>
<div class="section" id="what-is-uniswap">
<h2><span class="section-number">11.1. </span>What is Uniswap<a class="headerlink" href="#what-is-uniswap" title="Permalink to this headline">¶</a></h2>
<p>So for those of you who haven’t heard of Uniswap, what is Uniswap?</p>
<p>Uniswap is a so-called DeFi, or decentralized finance application, that allows swapping of tokens without any central authority. In
the case of Ethereum it’s ERC20 tokens.</p>
<p>So you don’t need a centralized exchange, the traditional way to exchange tokens or other crypto assets. Instead everything is governed by
smart contracts and works fully automatically on the blockchain.</p>
<p>Another interesting feature of Uniswap is that it doesn’t discover prices the usual way with the so-called order book, but uses a different
automatic price discovery system. The idea is that people can create so-called liquidity pools.</p>
<p>If they want other users to be able to swap two different tokens, then somebody can create a liquidity pool and put a certain amount of those two tokens
in this liquidity pool, and in return the creator of the pool will receive so-called liquidity tokens that are specific to this one pool.</p>
<p>Other users can use that pool to swap. They take some amount of one of the tokens out in exchange for putting an amount of the other token back in.</p>
<p>Additionally, people can also add liquidity to the pool and receive liquidity tokens, or they can also burn liquidity tokens in exchange for tokens from the pool.</p>
<p>And all these features are also implemented in the version of Uniswap that works on Cardano that we’re going to look at now.</p>
<div class="figure align-default">
<img alt="_images/pic__00149.png" src="_images/pic__00149.png" />
</div>
<p>So let’s look at the various operations that are available in turn.</p>
<p>It all starts by somebody setting up the whole system. So some organization or entity that wants to offer this Uniswap service.</p>
<p>It starts with a transaction that creates a UTxO at this script address, here we call that <em>factory</em> for Uniswap factory. It contains an NFT that identifies the factory,
the same trick that we have used a couple of times before, and as datum, it will contain the list of all liquidity pools.</p>
<p>So in the beginning, when the factory is just being created, that list will be empty.</p>
<p>Now let’s assume that one user, Alice wants to create a liquidity pool for tokens A and B. A pool that allows others to swap A against B or B against A.</p>
<div class="figure align-default">
<img alt="_images/pic__00150.png" src="_images/pic__00150.png" />
</div>
<p>She has to provide some initial liquidity for the pool. So she needs some amount of token A and some amount of token B, let’s say she has 1,000A and 2000B.</p>
<p>It’s important to note here that the ratio between A and B reflects Alice’s belief in the relative value of the tokens. So if she wants to set up a pool with
1000A and 2000B, then she believes that one A has the same value as two Bs.</p>
<p>In order to create the liquidity pool, she will create a transaction with two inputs and three outputs.</p>
<div class="figure align-default">
<img alt="_images/pic__00150.png" src="_images/pic__00150.png" />
</div>
<p>The two inputs will be the liquidity she wants to provide; the 1000A and 2000B and the Uniswap factory invoked with the create redeemer. The three outputs
will be the newly-created pool.</p>
<p>We call it <em>Pool AB</em> here to indicate that it contains tokens AB, which will contain the liquidity that Alice provided; the 1000A and the 2000B and a freshly-minted
token that identifies this pool, an NFT, called <em>AB NFT</em> here.</p>
<p>The datum of the pool, the 1415, will be the amount of liquidity tokens that Alice receives in return for setting up this pool and providing the liquidity. #</p>
<p>If you wonder about the number, that is the square root of the product of 1000 and 2000, so that’s how the initial amount of liquidity tokens is calculated. It
doesn’t really matter, you could scale it arbitrarily, but that’s the way Uniswap does it.</p>
<p>The second output is the Uniswap factory again, with the same NFT as before that identifies it. And now the datum has been updated. So in this list that was
empty before, the list of all liquidity pools, there is now an entry for the newly-created AB pool.</p>
<p>Finally, there’s a third output for Alice, where she receives the freshly-minted liquidity tokens, called <em>AB</em> here to indicate that they belong to the pool AB.</p>
<p>Now that the liquidity pool has been set up, other users can use it to swap.</p>
<div class="figure align-default">
<img alt="_images/pic__00151.png" src="_images/pic__00151.png" />
</div>
<p>So let’s assume that Bob wants to swap 100A against B. What will Bob do?</p>
<p>He will create a transaction that has two inputs and two outputs. The two inputs are the 100A he wants to swap, and the pool with the swap redeemer. The outputs
are the Bs he gets in return.</p>
<p>In this example, that would be 181B and the updated pool. So the pool now has the additional 100A that Bob provided. So now it’s 1,100A, and it has 181B fewer than before.</p>
<p>It still, of course, has the NFT that identifies the pool and the datum hasn’t changed because the amount of liquidity tokens that have been minted hasn’t changed.</p>
<p>Now, of course, the question is, where does this 181 come from? This is this ingenious idea, how price discovery works in Uniswap.</p>
<p>So the rule is roughly that the product of the amounts of the two tokens must never decrease. Initially we have 1000 As and 2000 Bs and the product is 2 million.</p>
<p>If you do the calculation, then you will see that after the swap 1100*1819 will be slightly larger than 2 million.</p>
<p>If you think about it or try a couple of examples by yourself, then you will see that in principle, you will always pay this ratio of the As and Bs in the pool, at least if you swap small amounts.</p>
<p>So originally the ratio from A to B was 1:2, 1000:2000. 100 is relatively small in comparison to the 1000 liquidity, so Bob should roughly get 200B, but he does get less
and there are two reasons for that.</p>
<p>One is that the amount of tokens in the liquidity pool is never allowed to go to zero. And the more of one sort you take out, the more expensive it gets -
the less you get in return. So 100 depletes the pool a bit of As, so Bob doesn’t get the full factor 2 out, he gets a little bit less out. That’s exactly how this product formula works.</p>
<p>This also makes it ingenious, because it automatically accounts for supply and demand. If the next person also wants to swap 100A, they would get even less out.</p>
<p>The idea is if a lot of people want to put A in and want to get B in return, that means the demand for B is high. And that means the price of B in relation to A
should rise. And that is exactly what’s happening.</p>
<p>So the more people do a swap in this direction, put A in and get B out, the less of the gap because the price of B rises. If there were swaps in the other direction,
you would have the opposite effect.</p>
<p>If there’s an equal amount of swaps from A to B and B to A, then this ratio between the two amounts would stay roughly the same.</p>
<p>There’s an additional reason why Bob doesn’t get the full 200 that he might expect, and that is fees.</p>
<p>We want to incentivize Alice to set up the pool in the first place. She won’t just do that for fun, she wants to profit from it, so she wants to earn on swaps that people make.</p>
<p>The original product formula is modified a bit to insist that the product doesn’t only not decrease, but that it increases by a certain amount, a certain percentage,
depending on how much people swap. That’s 3% in this example of the 100A that Bob swaps, and it would be the same if you swap B instead.</p>
<p>This is basically added on top of this product, so anytime somebody swaps, not only does the product not decrease, it actually increases. And the more people swap, the more it increases.</p>
<p>The idea is that if Alice now would close the pool by burning her liquidity tokens, she gets all the remaining tokens in the pool and the product
would be higher than what she originally put in.</p>
<p>So that’s her incentive to set up the pool in the first place.</p>
<p>The next operation we look at is the add operation where somebody supplies the pool with additional liquidity.</p>
<div class="figure align-default">
<img alt="_images/pic__00152.png" src="_images/pic__00152.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="week9.html" class="btn btn-neutral float-left" title="10. Week 09 - Marlowe" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright .

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>